---
title: "Florida Keys Reef Fish Biodiversity"
author: "Megan Hepner"
date: "April 28, 2017"
output: html_document
---

### Inputs 
1. species-trait matrix
1. psu abundance dataframe
1. psu biomass dataframe

### Outputs 
1.  Functional dendogram (Fig: The final ultrametric functional dendrogram for 348 reef fish in the Florida Keys obtained using hierarchial agglometric clustering.)
+ Trait-matrix visualization 

1.  By *strata* for each sampling year (using PSU data)  
+ Mean abundance and plot
+ Mean biomass and plot
+ Richness and plot
+ Simpson diversity as effective number of species and plot
+ Shannon diversity as effective number of species and plot
+ Functional diversity as effective number of species and plot
+ Pielou's evenness and plot 

1. By *strata grouped and subregion* for each sampling year (using PSU data) 
+ Mean abundance and plot
+ Mean biomass and plot
+ Richness and plot
+ Simpson diversity as effective number of species and plot
+ Shannon diversity as effective number of species and plot
+ Functional diversity as effective number of species and plot
+ Pielou's evenness and plot 

1. By *NTMR* for each sampling year (using PSU data) 
+ Mean abundance and plot
+ Mean biomass and plot
+ Richness and plot
+ Simpson diversity as effective number of species and plot
+ Shannon diversity as effective number of species and plot
+ Functional diversity as effective number of species and plot
+ Pielou's evenness and plot 

1. Figure of the FKNMS coral reef tract with strata, subregions, and NTMR 

1. Statistics 
- Interpolate diversity for each year and strata using kriging 
+ Figure. Spatial distribution of each matrices over time. 
- Extract and interpolate the residuals of each index fitted against each other using GAM
+ temporal variable: YEAR
+ spatial variable: Latitude, longitude
+ environmental variable: STRAT, habitat_cd, depth, bottom temperature 
+ management variable: NTMR 
- Calculate partial deviances 

### Reef Visual Census Background 

Reef fish community data used in this study were collected as part of the multi-agency Reef Visual Census (RVC) [Brandt et al., 2009](https://www.coris.noaa.gov/activities/fish_monitoring_protocol/). Fish communities were visually surveyed underwater annually in the mainland FKNMS (Lower Keys, Middle Keys and Upper Keys) from 1999 to 2012, and biennially from 2012 to 2016. The Dry Tortugas region was surveyed from 1999 to 2000 and biennially from 2004 to 2016.     

The RVC uses a stationary point count method within a randomly selected 7.5 m radius circular plot with a 200m map grid from 1999 to 2012 and 100m map grid from 2014 to 2016 to optimize the observation of conspicuous and diurnally active reef fish, specifically economically and ecologically important reef fish species [Bohnsack and Bannerot, 1986](https://docs.lib.noaa.gov/noaa_documents/NMFS/TR_NMFS/TR_NMFS_41.pdf). 

### Objective 

To analyze and compare changes in species richness, Simpson diversity, Shannon diversity and functional diversity in the Florida Keys National Marine Sanctuary (FKNMS) to reveal changes in temporal and spatial variability from 1999 â€“ 2016. The indices were assessed throughout the Florida Keys, between the upper and lower keys, between habitat types, and for different levels of management (Ecological Reserves (ER), Sanctuary Preservations Areas (SPA), and Special Use/Research Only Areas (SU/RO)). 

## Diversity indicse as effective number of species 

All indices were computed as effective number of species. Effective number of species is the number of equally abundance species needed to produce the observed value of a diversity index (Jost, 2006; Jost et al., 2010; MacArthur, 1965). Jost, 2006 refers to these as true measures of diversity, where prior to the conversion the diversity indices are simply measures of entropy. 

- Species Richness is the number of species in a habitat sampled  

$Richness = \sum_{i=1}^S p_i^0$  

- Simpson diversity measures the probability that two individuals randomly selected from a sample will belong to different species.   

$Simpson = 1 - \sum_{i=1}^S p_i^2$  

- Shannon diveristy is a measure of entropy, it is the uncertainty in the species identity of a sample  

$Shannon = - \sum_{i=1}^S p_i \log_b p_i$  

- Functional diversity (Rao's Q) is a measure of pairwise functional differences between species weighted by their relative abundances   

$Rao Q = \sum_{i=1}^S-1 \sum_{j=i+1}^S d_i p_i p_j$

```{r setup, include= F}
knitr::opts_chunk$set(echo = T)
#ln -s ~/Dropbox/big_csv big_csv - write in terminal window to link to 'big_csv' folder
#rm(list = ls())

#install.packages('devtools')
#devtools::install_github('jeremiaheb/rvc')
library(rvc) #calls RVC data from SEFSC server 
#install.packages("tidyverse")
library(tidyverse)
#install.packages("vegan")
library(vegan) # biodiveristy functions for richness, simpson, and shannon 
#install.packages("dygraphs")
library(dygraphs)
#install.packages("plotly")
#library(plotly)
#install.packages("webshot")
library(webshot)
#install.packages("htmlwidgets")
library(htmlwidgets)
#install.packages("FD")
library(FD)
#install.packages("iNEXT")
library(cowplot) #get_legend 

#RVCdata_FK = read_rds('big_csv/RVCdata_FK.rds')

map = purrr::map # override maps::map
select = dplyr::select #override MASS::select 
group_by =  dplyr::group_by #override plotly::group_by
summarise = dplyr::summarise #override plotly::summarise
```

## Functional distance trait based matrix (from Lefcheck et al., 2014 ChessMap.Rmd)

Gowdis computes the Gower (1971) similarity coefficient exactly as described by Podani (1999), then converts it to a dissimilarity coefficient by using D = 1 - S

```{r Functional distance matrix, eval = F}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("clue")
library(clue) #calls cl_ultrametric 
#install.packages("fpc")
library(fpc) #calls pamk
#install.packages("ape")
library(ape)
#install.packages("phytools")
library(phytools)
#install.packages("FD")
library(FD)
#biocLite("BiocUpgrade") ## you may need this
#biocLite("ggtree", type = "source")
library(tidyverse)

func_dist_rds <- "functional_diversity/func.dist.rds"

if (!file.exists(func_dist_rds)){
  
  trait_matrix = read_csv('functional_diversity/species_trait_matrix_348_spp.csv')
  
  trait_matrix = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)%>% 
    select(SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>% #348*9
    group_by(
      SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High")),
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix)=trait_matrix$SPECIES_CD 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist = gowdis(trait_matrix, ord="podani")
  
  #Use clustering method to produce ultrametric dendrogram because values of Rao's Q can be maximized when fewer than the max number of functional types are present unless distances are ultramtetric 
  
  #to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
  tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
  trees=lapply(tree_methods,  function(i) hclust(traits.dist, method=i))
  par(mfrow=c(3,2))
  for(i in 1:length(trees)) {plot(trees[[i]])} #plots the 5 different kinds of trees 
  
  #convert trees to ultrametric
  trees.ultra= lapply(trees,function(i) cl_ultrametric(as.hclust(i)))
  
  #Plot each tree
  par(mfrow=c(3,2))
  for (i in 1:length(trees.ultra)) {plot(trees.ultra[[i]])} #plots the 5 different kinds of trees 
  
  #Build the consensus tree (Mouchet et al 2008 Oikos)  
  ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
  class(ensemble.trees)
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 
  par(mar=c(1,1,1,1))
  plot(consensus.tree, horiz=T)
  
  #Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances 
  #spectral norm (2-norm) of the differences of the ultrametrics
  all.trees=c(trees.ultra,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist,method="spectral"))) 
  #Cross-dissimilarities using spectral ultrametric distance:
  #Single = 63.17399
  #complete = 116.8516
  #average = 14.99288
  #mcquitty = 36.06599
  #ward.D = 3161.581
  #consensus =  1065.058 (1067.782) (1091.628)
  
  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  
  #Confirm lowest 2-norm value,  spectral norm (2-norm) of the differences if the ultrametrics 
  cl_dissimilarity(func.dist,traits.dist,method="spectral") #Cross-dissimilarities using spectral ultrametric distance:  14.99288
  
  #Scale by the max value so that all values are between 0-1
  func.dist=func.dist/max(func.dist)
  
  saveRDS(func.dist, "functional_diversity/func_dist_rds")
} 
else { #read data 
  func.dist = read_rds("functional_diversity/func_dist_rds")
} 

#Plot the best tree - average 
pdf("functional_dendrogram.pdf", width = 30, height = 70)
par(mfrow=c(1,1))         #nc-by-nr array 
par(mar=c(2,1,0,2))       #number of lines of margins for bottom, left, top, right 
par(pin=c(25,58))         #plot dimensions 
plot(func.dist, horiz=TRUE, main = "Functional Dendrogram", cex = 1, cex.main = 2, cex.lab = 0.5)
dev.off()

#Phylogenetic tree with 348 tips and 347 internal nodes. 
func.dist.phy = as.phylo(as.hclust(func.dist))

#Write newick tree
write.tree(func.dist.phy, "functional_diversity/functional_dendrogram.nwk")
#write.nexus(func.dist.phy, "functional_diversity/functional_dendrogram.nex") 

tree <- read.tree("functional_diversity/functional_dendrogram.nwk")
# List of 4
#  $ edge       : int [1:694, 1:2] 
#  $ Nnode      : int 347
#  $ tip.label  : chr [1:348] 
#  $ edge.length: num
# - attr(*, "class")= chr "phylo"
# - attr(*, "order")= chr "cladewise"

# Phylogenetic tree with 348 tips and 347 internal nodes.
# Tip labels:
# 	KYP_SECT, ALE_CILI, ELO_SAUR, HAR_JAGU, CEN_UNDE, TYL_CROC, ...
# Rooted; includes branch lengths.

plot(tree, label.offset=0.2, edge.width = 2, type = "cladogram")  
nodelabels() #add node numbers
tiplabels() #add tip numbers

ggtree(tree, branch.length = T) +
  ggtitle("Functional Dendogram") +
  geom_tiplab()+
  geom_text(aes(x = branch, label=branch.length), vjust = -.5) +
  theme_tree2()

ggtree(tree, layout= "circular") +
  ggtitle("Functional Dendogram") +
  geom_tiplab(size = 1, aes(angle=angle))+
  theme_tree2()

# transformed to a tidy data.frame by fortify method
tree_data <- fortify(tree) #node; parent; branch.length; x; y; label; isTip; branch; angle 
head(tree_data)

#Visualize species' differences in multivariate trait space
#Perform k-means clustering with no a priori specification for k
traits.kclus= pamk(traits.dist, krange=2:10) 

#krange: integer vector. Numbers of clusters which are to be compared by the average silhouette width criterion.
#traits.kclus$nc = 10 
#traits.kclus$crit 0.0000000 0.2374706 0.2362513 0.2355555 0.2681756 0.2581352 0.2759547 0.2852216 0.3006077 0.3062123

# #Perform multidimensional scaling on functional dendrogram
traits_nmds = metaMDS(traits.dist,k=traits.kclus$nc,trymax=20)
#k = Number of dimensions

#*** No convergence -- monoMDS stopping criteria:
#499: no. of iterations >= maxit
#1: stress ratio > sratmax

# Dimensions: 10 
# Stress:     0.03545178 
# Stress type 1, weak ties
# No convergent solutions - best solution after 500 tries
# Scaling: centring, PC rotation 
# Species: scores missing


# #Plot in two dimensions - doesn't work 
par(mar=c(4,4,1,1))
ordiplot(traits_nmds,type="n")

#Assign colors to different groups
groups=levels(factor(traits.kclus$pamobject$clustering))
points.symbols=15:16
points.colors=c("firebrick3","cornflowerblue")
for(i in seq_along(groups)) {
  points(traits_nmds$points[traits.kclus$pamobject$clustering==groups[i],],
         pch=points.symbols[i],col=points.colors[i],cex=1.4) }
ordispider(traits_nmds,factor(traits.kclus$pamobject$clustering),label=F)
ordihull(traits_nmds,factor(traits.kclus$pamobject$clustering),lty="dotted")
orditorp(traits_nmds,dis="sites",pcex=0,air=0.5,col="grey10",cex=0.8)

```

## Trait matrix visualization 

[http://jkunst.com/r/pokemon-visualize-em-all/]
[https://d3js.org/]
[http://www.buildingwidgets.com/blog/2015/7/22/week-29-d3treer-v2]

```{r trait visualization}

library(tidyverse)
library(treemap)
devtools::install_github("gluc/data.tree")
devtools::install_github("timelyportfolio/d3treeR")
library(d3treeR)
devtools::install_github("GuangchuangYu/ggtree") #requires R>= 3.3.2
library(ggtree)

trait_matrix = read_csv('functional_diversity/species_trait_matrix_348_spp.csv')

trait_matrix_treemap = trait_matrix %>%
  select(Common_name, Maxlength, Trophic_level, Trophic_group, Water_column,Diel_activity,Substrate_type,Complexity, Gregariousness) %>% 
  group_by(Maxlength,
           Trophic_level,
           Trophic_group,
           Water_column,
           Diel_activity,
           Substrate_type,
           Complexity,
           Gregariousness) %>%
  summarise(n = n())%>% 
  ungroup() %>%
  as.data.frame()

treemap2 = 
  d3treeR::d3tree2(
    treemap(
      dtf = trait_matrix_treemap,
      index = c("Trophic_group", "Trophic_level"), #, "Water_column", "Complexity", "Substrate_type", "Diel_activity"),
      vSize = "n", 
      vColor = "Trophic_group",
      type = "index"),
    #title = "Reef Fish Traits",
    #fontsize.title = 14, 
    #algorithm = "squarified"
    rootname = "Species_Traits")

#treemap example 
data(GNI2014)
d3tree2(
  treemap(
    GNI2014
    ,index=c("continent", "iso3")
    ,vSize="population"
    ,vColor="GNI"
    ,type="value"
  )
  , rootname = "World"
)

```

### Fetch the RVC data from 
[NOAA's Southeast Fisheries Science Center server](https://grunt.sefsc.noaa.gov/rvc_analysis20/) using the [RVC package](https://github.com/jeremiaheb/rvc)
- Fetched weighted abundance and biomass data by domain, strata, and primary sampling units 

### Sample Data Variables
- PRIMARY_SAMPLE_UNIT: A code indicating the primary sample unit in which a sample was collected.
- YEAR: A number indicating the calendar year.
- MONTH: A number indicating the month of the year.
- DAY: A number indicating the day of the month (EST).
- STATION_NR: A number indicating the secondary sampling unit within a given primary sample unit.
- LAT_DEGREES: Latitude of secondary sampling unit in decimal degrees).
- LON_DEGREES: Longitude of secondary sampling unit in decimal degrees).
- DEPTH: Average depth, in meters, of secondary sampling unit).
- UNDERWATER_VISIBILITY: visibility, in meters, at secondary sampling unit.
- MAPGRID_NR: A number indicating the primary sample unit.  
- HABITAT_CD: A code indicating the habitat type. 
- ZONE_NR: A code indicating the distance offshore: 
+ 1 - Inshore
+ 2 - Midchannel
+ 3 - Offshore
+ 4 - Fore-reef
- SUBREGION_NR: A number indicating the subregion.
- MPA_NR: A number identifying the marine protected area in which the sample was collected. Zero indicates unprotected status)
- SPECIES_NR: A number indicating the species for a sample 
- SPECIES_CD: A code indicating the species for a sample. Consists of the first three letters of the generic name and the first four of the specific name   
- LEN: The length, in cm, of a sample.      
- NUM: The number of individuals of a given species and length observed in a secondary sampling unit
- TIME_SEEN: A number indicating when, during sampling, an individual was observed. 1: In the first five minutes, 2: From 5-10 minutes, 3: After 10 minutes. 
- PROT: A boolean value indicating whether a sample was in a protected area or not 
+ 1 - protected area
+ 0 - not protected 
- STRAT: A code indicating the stratum in which a sample was taken. Differs by region.   
+ FMLR
+ FSLR
+ HRRF
+ INPR
+ MCPR 
+ OFPR
- REGION: A code indicating the region in which a sample was taken.
+ FLA KEYS (florida keys)
+ DRY TORT (dry tortugas)

### Stratum Data Variables 
- REGION 
- YEAR 
- PROT 
- STRAT 
- NTOT: The number of possible primary sample units for a given year, region, stratum, and protected status 
- GRID_SIZE: The length (in meters) to a side of a primary sample unit for a given year, region, stratum, and protected status.

### Taxonomic Data Variables 
- SPECIES_CD
- FAMILY
- SCINAME 
- COMNAME
- LC: Minimum length at capture, in centimeters
- LM: Median length at maturity, in centimeters.
- WLEN_A: The linear coefficient of the allometric growth equation in grams per millimeter (g/mm)
- WLEN_B: The exponential coefficient of the allometric growth equation

### Benthic Data Variables 
- REGION: A code indicating the region. 
- YEAR: A number indicating the calendar year.
- PRIMARY_SAMPLE_UNIT: A code indicating the primary sample unit in which a sample was collected.
- STATION_NR: A number indicating the secondary sampling unit within a given primary sample unit.
- DEPTH: Average depth, in meters, of secondary sampling unit.
- MAX_HARD_RELIEF: The maximum height, in meters, of hard relief (e.g. hard corals, rock).
- MAX_SOFT_RELIEF: The maximum height, in meters, of soft relief (e.g. soft corals, sponges).
- AVG_HARD_RELIEF: The average height, in meters, of hard relief.
- HARD_REL_PCT_0: Percentage of hard relief less than 0.2 meters.
- HARD_REL_PCT_1: Percentage of hard relief between 0.2 and 0.5 meters.
- HARD_REL_PCT_2: Percentage of hard relief between 0.5 and 1.0 meters.
- HARD_REL_PCT_3: Percentage of hard relief between 1.0 and 1.5 meters.
- HARD_REL_PCT_4: Percentage of hard relief greater than 1.5 meters.
- PCT_SAND: Percentage of abiotic cover that is sand.
- PCT_HARD_BOTTOM: Percentage of abiotic cover that is hard bottom.
- PCT_RUBBLE: Percentage of abiotic cover that is rubble.
- PCT_CORAL: Percentage of biotic hardbottom that is coral.
- PCT_OCTO: Percentage of biotic hardbottom that is octocoral.
- PCT_SPONGE: Percentage of biotic hardbottom that is sponge.

### Function: getDomainDensity 
- YEAR
- REGION
- SPECIES_CD
- density: Domain-wide mean density for a stratified random survey  
- var: Variance in average density per secondary sampling unit
- n: Number of primary sampling units sampled
- nm: Number of secondary sampling units sampled
- N: Number of total possible primary sample units
- NM: Number of possible secondary sampling units
- length_class: The length class or bin. Only present if length_bins is not NULL. The notation, [lower, upper), is inclusive of the lower bound, but exclusive of the upper bound
- protected_status: The protected status. Only present if merge_protected is FALSE

### Florida Keys Strata
1. FSLR - Forereef Shallow Linear Reef (<6m)
2. FMLR - Forereef Midchannel Linear Reef (6-18m)
3. FDLR - Forereef Deep Linear Reef (18-33m)
4. INPR - Inshore patch reef
5. MCPR - Midchannel Patch Reef 
6. OFPR - Offshore Patch Reef
7. HRRF - High Relief Reef (Spur and Groove)

### Florida Keys Primary Sampling Unit 

```{r psu abundance}

if(!file.exists("psu_abun_sum_rds")){
  #read in data 
  psu_fk_abun <- read_csv("big_csv/abundance_psu/psu_fk_abun.csv",
                          col_types = cols(protected_status = col_character()))
  #dim(psu_fk_abun) #3,643,306 x 10

  #remove species not identified in species level and protected status all 
  psu_fk_abun_no_spp = psu_fk_abun %>%
    filter(!stringr::str_detect(SPECIES_CD, 'SPE\\.$'))  %>%
    filter(stringr::str_detect(protected_status, 'all')) 
  #dim(psu_fk_abun_no_spp) #1,689,982 x 10
  
  #sum the abundance values and remove any PSU's with no species
  psu_abun_sum <- psu_fk_abun_no_spp %>%
    group_by(YEAR, PRIMARY_SAMPLE_UNIT, STRAT) %>%
    summarize(abundance_sum = sum(abundance)) %>%
    filter(!abundance_sum == "0")
    #dim(psu_abun_sum) #5241*4
    
  #remove PSU-'s with 1 species [2006,602U INPR] [2016,  1010U, INPR]
  psu_abun_sum = psu_abun_sum[!(psu_abun_sum$YEAR == "2006" & psu_abun_sum$PRIMARY_SAMPLE_UNIT == "602U" | psu_abun_sum$YEAR == "2016" & psu_abun_sum$PRIMARY_SAMPLE_UNIT == "1010U"),] 
  #dim(psu_abun_sum) # 5239 x 4 

  saveRDS(psu_abun_sum, "psu_abun_sum_rds")

} else{
  psu_abun = read_rds("psu_abun_sum_rds")
}

```

```{r psu biomass}

if(!file.exists("psu_bio_sum_rds")){
 
  #read in data 
  psu_fk_bio <- read_csv('big_csv/biomass_psu/psu_fk_biomass.csv', 
                         col_types = cols( protected_status = col_character())) 
    #dim(psu_fk_bio) 3,429,476*10

  #remove species not identified in species level and protected status all   
  psu_fk_bio_no_spp = psu_fk_bio %>%
    filter(!stringr::str_detect(SPECIES_CD, 'SPE\\.$')) %>% #348 species  
    filter(stringr::str_detect(protected_status, 'all')) 
    #dim(psu_fk_bio_no_spp) 1,609,672 x 10
  
  #sum the biomass values and remove any PSU's with no species 
  psu_bio_sum <- psu_fk_bio_no_spp %>%
    group_by(YEAR, PRIMARY_SAMPLE_UNIT, STRAT, PROT) %>%
    summarize(biomass_sum = sum(biomass)) %>%
    filter(!biomass_sum == "0")
    #dim(psu_bio_sum) #5241    5
  
  #remove PSU's with 1 species [2006,602U INPR] [2016,  1010U, INPR]
  psu_bio_sum = psu_bio_sum[!(psu_bio_sum$YEAR == "2006" & psu_bio_sum$PRIMARY_SAMPLE_UNIT == "602U" | psu_bio_sum$YEAR == "2016" & psu_bio_sum$PRIMARY_SAMPLE_UNIT == "1010U"),]
  #dim(psu_bio_sum) #5239    5
  
   saveRDS(psu_bio_sum, "psu_bio_sum_rds")
   
  } else{ #read data 
  psu_bio = read_rds("psu_bio_sum_rds")
}

```

```{r psu biodiversity}

if(!file.exists("psu_div_rds")){
  
  #read in psu abundance data 
  psu_fk_abun <- read_csv("big_csv/abundance_psu/psu_fk_abun.csv", col_types = cols(protected_status = col_character())) 
  #dim(psu_fk_abun) #3,643,306*10
  
  ##remove species not identified in species level and protected status all
  psu_fk_abun_no_spp = psu_fk_abun %>%
    filter(!stringr::str_detect(SPECIES_CD, 'SPE\\.$')) %>%
    filter(stringr::str_detect(protected_status, 'all')) 
    #dim(psu_fk_abun_no_spp) #1,689,982      10
  
  #read in trait matrix 
  trait_matrix = read_csv('functional_diversity/species_trait_matrix_348_spp.csv')
  
  #trait matrix needs to be alphabetically for FD code 
  trait_matrix = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)
  
  #compute diversity indices by PSU  
  psu_diversity = psu_fk_abun_no_spp %>%  
    select(YEAR, PRIMARY_SAMPLE_UNIT,STRAT,PROT,SPECIES_CD,abundance) %>% #tibble: 1,689,982 x 6
    group_by(YEAR, PRIMARY_SAMPLE_UNIT, STRAT, PROT) %>% 
    nest(-YEAR) %>%
    mutate(
      data_wide = map(data, function(x) 
        full_join(x, trait_matrix %>% select(SPECIES_CD), by='SPECIES_CD') %>%
          mutate(abundance = ifelse(is.na(abundance), 0, abundance)) %>%
          spread(SPECIES_CD, abundance, fill =0)),
      data_wide = map(data, ~ spread(data=.x, SPECIES_CD, abundance, fill =0)), 
      richness = map( #species richness
        data_wide, 
        function(x) specnumber(x)),
      simpson = map( #simpson diversity as effective number of species 
        data_wide,
        function(x) 1/(1 - diversity(x, index = 'simpson'))),
      shannon = map( #shannon diversity as effective number of species 
        data_wide, 
        function(x) exp(diversity(x,  index = 'shannon')))) %>% 
    unnest(richness, simpson, shannon)
  #dim(psu_diversity) #5,241 x 7
  
    #remove PSU-'s with 1 species [2006,602U INPR] [2016,  1010U, INPR]
  psu_diversity = psu_diversity[!(psu_diversity$YEAR == "2006" & psu_diversity$PRIMARY_SAMPLE_UNIT == "602U" | psu_diversity$YEAR == "2016" & psu_diversity$PRIMARY_SAMPLE_UNIT == "1010U"),] 
  #dim(psu_diversity) #5,239 x 9
  
  saveRDS(psu_diversity, "psu_div_rds")

} else { #read data 
  psu_div = read_rds("psu_div_rds")
}

```

```{r biodiversity 2.0}

if(!file.exists("fd_eveness_rds")){
  
  func.dist = read_rds("functional_diversity/func_dist_rds")
  
  psu_fk_abun <- read_csv("big_csv/abundance_psu/psu_fk_abun.csv", col_types = cols(protected_status = col_character())) #3,643,306*10
    ##remove species not identified in species level and protected status all
  
  psu_fk_abun_no_spp = psu_fk_abun %>%
    filter(!stringr::str_detect(SPECIES_CD, 'SPE\\.$')) %>%
    filter(stringr::str_detect(protected_status, 'all')) 
    #dim(psu_fk_abun_no_spp) #1,689,982      10
  
  #sample_data = as.tibble(read_csv("big_csv/sample_data/FK/sample_data_all_years.csv"))
  #read in trait matrix 
  #trait_matrix = read_csv('functional_diversity/species_trait_matrix_348_spp.csv')
  
  #trait matrix needs to be alphabetically for FD code 
  trait_matrix = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)
  
  traits = read.csv('functional_diversity/species_trait_matrix_348_spp.csv')

  # Set rownames on traits and remove other info
    rownames(traits) <- traits$SPECIES_CD
    traits <- traits[, -c(1:4)]
    # Convert rownames to all caps
    rownames(traits) <- toupper(rownames(traits))
  
  #dim(psu_fk_abun) #3643306      10
  
  psu_fk_abun_no_spp = psu_fk_abun %>%
    filter(!stringr::str_detect(SPECIES_CD, 'SPE\\.$'))  
  dim(psu_fk_abun_no_spp) #3,379,964      10
  
  abund = psu_fk_abun_no_spp %>% 
    filter(protected_status != "all") %>% #1,689,982 x 10
    select(YEAR, PRIMARY_SAMPLE_UNIT,STRAT,PROT, SPECIES_CD, abundance) #1,689,982 * 6
  
  # Cast abundance longways (species as columns)
  abundmat <- spread(abund, SPECIES_CD, abundance, fill = 0)
  #dim(abundmat) #5241  352
  
  # What is up with these species not being in the trait matrix??
  checkthese <- colnames(abundmat)[!colnames(abundmat) %in% rownames(traits)]
  
  # Subset species whose names only appear in traits
  abundmat <- abundmat[colnames(abundmat) %in% rownames(traits)] 
  #dim(abundmat) #5,241    348
  
  # Drop communities with no species (roughly 500 sites)
  abundmat <- abundmat[!rowSums(abundmat) == 0,] 
  #dim(abundmat) #5,241     348
  abundmat <- abundmat[!rowSums(abundmat) == 1,]
  #dim(abundmat) #5240  348
  
  #Calculate relative values for community matrix
  rel.mat=abundmat/apply(abundmat,1,sum)
  
  #Compute species diversity
  species.dist=matrix(1,ncol(abundmat),ncol(abundmat))-diag(rep(1,ncol(abundmat))) 
  species.div=1/(1-apply(rel.mat,1,function(x) t(x) %*% species.dist %*% x))
  
  #Compute evenness (as in Jost 2010 Diversity)
  evenness=log(species.div)/log(rowSums(abundmat>0))
  
  #Ensure that all evenness calculations are not >1 (bug)
  #func.div=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(traitsmat) %*% x))
  
  #Ensure that all evenness calculations are not >1 (bug)
  func.div=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(func.dist) %*% x))
  
  #Bind all to the original dataframe (need to remove psu with 1 species detected)
  list = cbind(sample_data,evenness,species.div,func.div)
  
  fd_evenness = list %>%
    select(PRIMARY_SAMPLE_UNIT, YEAR,STRAT,PROT,species.div,func.div,evenness) %>%
    group_by(YEAR,PRIMARY_SAMPLE_UNIT)
  
  saveRDS(fd_evenness,"fd_eveness_rds")
  
} {else
  fd_evenness = read_rds("fd_eveness_rds")
}

```

```{r bind psu matrices and sample data}

if(!file.exists("psu_matrices_data_rds")){
  psu_abun = read_rds("psu_abun_sum_rds") #5,241*4
  psu_bio = read_rds("psu_bio_sum_rds") #5,241*5
  psu_div = read_rds("psu_div_rds") # #5,241*7
  fd_evenness = read_rds("fd_eveness_rds")
  sample_data = as.tibble(read_csv("big_csv/sample_data/FK/sample_data_all_years.csv")) 
  #PRIMARY_SAMPLE_UNIT, YEAR, MONTH, DAY, STATION_N,R LAT_DEGREES, LON_DEGREES, DEPTH, UNDERWATER_VISIBILITY, MAPGRID_NR, HABITAT_CD, ZONE_NR, SUBREGION_NR, MPA_NR, PROT, STRAT
  
  all_matrices = inner_join(psu_abun, psu_bio) #5,241*6 (+mean abundance and biomass)
  all_matrices = inner_join(all_matrices, psu_div) #5,241*9 (+richness, simpson, shannon)
  all_matrices = inner_join(all_matrices, fd_evenness) #5,241*12(+spec.div, functional.div, evenness)
  all_matrices_data = inner_join(all_matrices, sample_data) #5,241 x 24

  saveRDS(all_matrices_data, "psu_matrices_data_rds")

  } else{
  all_matrices_data = read_rds("psu_matrices_data_rds")
  }

```

## Plots

- create multiplot function from (https://stackoverflow.com/questions/24387376/r-weird-error-could-not-find-function-multiplot)


```{r Plot by year and strata...old}
## copied code from chunk 10 to here before making too many changes to chunk 10; chunk 10 code is now working for combining plots but didn't want to delete the code below
all_matrices_data = read_rds("psu_matrices_data_rds")

if(!file.exists("stats_all_matrices_data_rds")){
  
  stats_all_matrices_data = all_matrices_data %>%
    group_by(YEAR, STRAT) %>% #110 groups 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
  saveRDS(stats_all_matrices_data, "stats_all_matrices_data_rds")
  
  } else{ 
  stats_all_matrices_data = read_rds("stats_all_matrices_data_rds")
  }

# plot mean and se across strat and year using line graphs

# BY STRAT and YEAR
#abundance 
ab_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=abundance_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance", colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="none", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      axis.text.x=element_text(angle=90,vjust=0.5,hjust=1),
      plot.caption = element_text(size=10))
#ggsave(file="abundance_by_year_and_strata.pdf", path="big_csv/plots")

#biomass
bio_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=biomass_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2) +
  labs(title= "B) Biomass", x="Year", y="Mean biomass", colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      axis.text.x=element_text(angle=90,vjust=0.5,hjust=1),
      plot.caption = element_text(size=10))
#ggsave(file="biomass_by_year_and_strata.pdf", path="big_csv/plots")

#richness
rich_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=richness_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2)+
  labs(title= "C) Richness", x="Year", y="Mean effective number of species", colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      axis.text.x=element_text(angle=90,vjust=0.5,hjust=1),
      plot.caption = element_text(size=10))
#ggsave(file="richness_by_year_and_strata.pdf", path="big_csv/plots")

# evenness
eve_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=evenness_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=evenness_mean+evenness_se,ymin=evenness_mean-evenness_se),width=0.1)+
  labs(title= "D) Evenness", x="Year", y="Mean relative evenness",colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="none", #right
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      axis.text.x=element_text(angle=90,vjust=0.5,hjust=1),
      plot.caption = element_text(size=10))
#ggsave(file="functional_diversity_by_year_and_strata.pdf", path="big_csv/plots")

#simpson
sim_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=simpson_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.2)+
  labs(title= "E) Simpson", x="Year", y="Mean effective number of species",colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      axis.text.x=element_text(angle=90,vjust=0.5,hjust=1),
      plot.caption = element_text(size=10))
#ggsave(file="simpson_diversity_by_year_and_strata.pdf", path="big_csv/plots")

# shannon
shan_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=shannon_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=shannon_mean+shannon_se,ymin=shannon_mean-shannon_se),width=0.1)+
  labs(title= "F) Shannon", x="Year", y="Mean effective number of species",colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      axis.text.x=element_text(angle=90,vjust=0.5,hjust=1),
      plot.caption = element_text(size=10))
ggsave(file="shannon_diversity_by_year_and_strata.pdf", path="big_csv/plots")

# functional
func_ys= ggplot(stats_all_matrices_data,aes(x=YEAR,y=func.div_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=func.div_mean+func.div_se,ymin=func.div_mean-func.div_se),width=0.1)+
  labs(title= "G) Functional", x="Year", y="Mean effective number of species",colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      axis.text.x=element_text(angle=90,vjust=0.5,hjust=1),
      plot.caption = element_text(size=10))
#ggsave(file="functional_diversity_by_year_and_strata.pdf", path="big_csv/plots")

#combine multiple plots
multiplot <- function(plotlist=c(ab_ys, rich_ys, sim_ys, func_ys, bio_ys, eve_ys, shan_ys), layout= )
checkit = multiplot(ab_ys, rich_ys, sim_ys, func_ys, bio_ys, eve_ys, shan_ys, cols = 2)
#want to remove STRAT. Just wamt one legend ideally. 

grid.arrange(
  arrangeGrob(ab_ys,bio_ys, ncol=2, nrow=1), 
  arrangeGrob(rich_ys,eve_ys, ncol=2, nrow=1),
  arrangeGrob(sim_ys,shan_ys, ncol=2, nrow=1),
  func_ys,
  #arrangeGrob(func_ys, ncol=2, nrow=1), 
  bottom = "Year") #heights=c(4,4,4), widths=c(16,16,16))

grid.arrange(
  arrangeGrob(ab_ys,bio_ys, eve_ys, ncol=3, nrow=1), 
  arrangeGrob(rich_ys, sim_ys,shan_ys, func_ys, ncol=4, nrow=1), bottom = "Year", heights=c(8,8))

grid.arrange(
  arrangeGrob(rich_ys,sim_ys, ncol=2, nrow=1),
  arrangeGrob(shan_ys,func_ys, ncol=2, nrow=1),bottom = "Year", left = "Effective number of species")
#want to remove STRAT. Just wamt one legend ideally. 


grid.arrange(
  arrangeGrob(ab_ys,bio_ys, ncol=2, nrow=1), 
  arrangeGrob(rich_ys,sim_ys, ncol=2, nrow=1),
  arrangeGrob(shan_ys,func_ys, ncol=2, nrow=1),bottom = "Year") #heights=c(4,4,4), widths=c(16,16,16))
#want to remove STRAT. Just wamt one legend ideally. 
#save legend
legend <- get_legend(ab_ys)

#########KATIE: I tried using multiplot and grid.arrange but I couldn't get the height and width functions to work correctly. I am thinking we only need one legend of Strat. Preferable enlarged on the right with all 7 plots, but that might be something that has to be done in powerpoint or paint. Maybe also have the bottom read "Year" so that its not below each chart. I am thinking the order should be: 
#           a)Mean abundance, b)Mean Biomass, 
#           c)Richness,        d)Evennnesss, 
#           e)Simpson,         f) Shannon, 
#           g) Functional 

```

## Questions

- Are diversity values and strata related? 
- Are diversity values and subregions related? 
- Are diversity values and protection level related?

## Plots of diversity indices by strata across all years 

```{r Plot by year and strata}

library(cowplot)
library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
library(tidyverse)

all_matrices_data = read_rds("psu_matrices_data_rds")

if(!file.exists("stats_all_matrices_data_rds")){
  
  stats_all_matrices_data = all_matrices_data %>%
    group_by(YEAR, STRAT) %>% #110 groups 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
  saveRDS(stats_all_matrices_data, "stats_all_matrices_data_rds")
  
  } else{ 
  stats_all_matrices_data = read_rds("stats_all_matrices_data_rds")
  }

# plot mean and se across strat and year using line graphs

# BY STRAT and YEAR
#abundance 
ab_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=abundance_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance", colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none", #"none", "right",c(0.8,0.68),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#y=expression(paste("Mean abundance (ind/40,000 km"^"2)")) #in case we need to use superscript in axis label, here is code. it was hard to figure out so I'm leaving it here
#ggsave(file="abundance_by_year_and_strata.pdf", path="big_csv/plots")

#biomass
bio_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=biomass_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2) +
  labs(title= "B) Biomass", x="Year", y="Mean biomass", colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="biomass_by_year_and_strata.pdf", path="big_csv/plots")

# evenness
eve_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=evenness_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=evenness_mean+evenness_se,ymin=evenness_mean-evenness_se),width=0.1)+
  labs(title= "C) Evenness", x="Year", y="Mean relative evenness",colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none", #right
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="evenness_by_year_and_strata.pdf", path="big_csv/plots")

#richness
rich_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=richness_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2)+
  labs(title= "D) Richness", x="Year", y="Mean ENS", colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="richness_by_year_and_strata.pdf", path="big_csv/plots")

#simpson
sim_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=simpson_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.2)+
  labs(title= "E) Simpson", x="Year", y="Mean ENS", colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="simpson_diversity_by_year_and_strata.pdf", path="big_csv/plots")

# shannon
shan_ys = ggplot(stats_all_matrices_data,aes(x=YEAR,y=shannon_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=shannon_mean+shannon_se,ymin=shannon_mean-shannon_se),width=0.1)+
  labs(title= "F) Shannon", x="Year", y="Mean ENS", colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="shannon_diversity_by_year_and_strata.pdf", path="big_csv/plots")

# functional
func_ys= ggplot(stats_all_matrices_data,aes(x=YEAR,y=func.div_mean, colour=STRAT, group=STRAT))+ #shape=STRAT
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=func.div_mean+func.div_se,ymin=func.div_mean-func.div_se),width=0.1)+
  labs(title= "G) Functional", x="Year", y="Mean ENS", colour = "Strata")+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="functional_diversity_by_year_and_strata.pdf", path="big_csv/plots")

#save legend
for_legend_vert = ggplot(stats_all_matrices_data,aes(x=YEAR,y=abundance_mean, colour=STRAT, group=STRAT))+
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  labs(colour = "Strata")+
  theme(
      legend.position="right", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))
legend_vert <- get_legend(for_legend_vert)

for_legend_horiz = ggplot(stats_all_matrices_data,aes(x=YEAR,y=abundance_mean, colour=STRAT, group=STRAT))+
  geom_line(aes(group=STRAT),lwd=1) +
  geom_point(size=3) +
  labs(colour = "Strata")+
  theme(
      legend.position="bottom", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))
legend_horiz <- get_legend(for_legend_horiz)

#combine multiple plots
#all plots on one page
g_ys <- grid.arrange(ab_ys,bio_ys,eve_ys,rich_ys,sim_ys,shan_ys,func_ys,legend_vert,ncol=2)
ggsave(file="all_indices_by_year_and_strata.pdf", g_ys, width=7, height=10, path="big_csv/plots")

#plots on two pages - letters in plot titles will need to be changed so they make sense on two pages (i.e., A-C and A-D)
g1 <- grid.arrange(ab_ys,bio_ys,eve_ys,legend_vert,ncol=2)
ggsave(file="ab_bio_eve_by_year_and_strata.pdf", g1, width=7, height=5, path="big_csv/plots")

g2 <- grid.arrange(arrangeGrob(rich_ys,sim_ys,ncol=2),arrangeGrob(shan_ys,func_ys,ncol=2),legend_horiz,nrow=3,heights=c(2,2,.4))
ggsave(file="rich_shan_sim_func_by_year_and_strata.pdf", g2, width=7, height=6, path="big_csv/plots")

#left=textGrob("Mean number of effective species", gp=gpar(fontsize=12), rot=90), bottom=textGrob("Year",gp=gpar(fontsize=12))) #code to insert global x and y axis labels

### ***Don't need to combine plots by STRAT and by YEAR just YEAR & STRAT for now***

# plot mean and se by years across strat and by strat across years using bar graphs

# by STRAT
#abundance 
ggplot(stats_all_matrices_data, aes(x=STRAT, y=abundance_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=abundance_mean-abundance_se, ymax=abundance_mean+abundance_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#biomass
ggplot(stats_all_matrices_data, aes(x=STRAT, y=biomass_mean)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#richness 
ggplot(stats_all_matrices_data, aes(x=STRAT, y=richness_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#simpson 
ggplot(stats_all_matrices_data, aes(x=STRAT, y=simpson_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#shannon 
ggplot(stats_all_matrices_data, aes(x=STRAT, y=shannon_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=shannon_mean-shannon_se, ymax=shannon_mean+shannon_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

# functional 
ggplot(stats_all_matrices_data,aes(x=STRAT,y=func.div_mean))+ 
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=func.div_mean-func.div_se, ymax=func.div_mean+func.div_se), width=.2,  position=position_dodge(.9))+ 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

# evenness
ggplot(stats_all_matrices_data,aes(x=STRAT,y=evenness_mean))+ 
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=evenness_mean-evenness_se, ymax=evenness_mean+evenness_se), width=.2,  position=position_dodge(.9))+ 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

# by YEAR
#abundance 
ggplot(stats_all_matrices_data, aes(x=YEAR, y=abundance_mean, group=YEAR)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=abundance_mean-abundance_se, ymax=abundance_mean+abundance_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#biomass 
ggplot(stats_all_matrices_data, aes(x=YEAR, y=biomass_mean, group=YEAR)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2, position=position_dodge(.9)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) +
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#richness 
ggplot(stats_all_matrices_data, aes(x=YEAR, y=richness_mean, group=YEAR)) +  
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#simpson 
ggplot(stats_all_matrices_data, aes(x=YEAR, y=simpson_mean, group=YEAR)) +  
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#shannon
ggplot(stats_all_matrices_data, aes(x=YEAR, y=shannon_mean, group=YEAR)) +  
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=shannon_mean-shannon_se, ymax=shannon_mean+shannon_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#functional
ggplot(stats_all_matrices_data, aes(x=YEAR, y=func.div_mean, group=YEAR)) +  
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=func.div_mean-func.div_se, ymax=func.div_mean+func.div_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#evenness
ggplot(stats_all_matrices_data, aes(x=YEAR, y=evenness_mean, group=YEAR)) +  
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=evenness_mean-evenness_se, ymax=evenness_mean+evenness_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

```

## Plots of diversity indices by grouped strata across all years 

Group strata by: patch reef, forereef, and high relief 

```{r Plot by year and grouped strata} 

if(!file.exists("matrices_strat_grouped_rds")){
  
  all_matrices_data = read_rds("psu_matrices_data_rds")
  
  matrices_strat_grouped = all_matrices_data %>% 
    mutate(
      STRAT_GROUPED = 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
    group_by(YEAR, STRAT_GROUPED) %>% 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
  saveRDS(matrices_strat_grouped, "matrices_strat_grouped_rds")
  } else {
    matrices_strat_grouped = read_rds("matrices_strat_grouped_rds")
    }

# by STRAT_GROUPED and YEAR
#abundance
ab_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=abundance_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="abundance_by_year_and_strata_grouped.pdf", path="big_csv/plots")

#biomass
bio_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=biomass_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.1)+
  labs(title= "B) Biomass", x="Year", y="Mean biomass", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="biomass_by_year_and_strata_grouped.pdf", path="big_csv/plots")

#evenness
eve_gs = ggplot(matrices_strat_grouped,aes(x=YEAR,y=evenness_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=evenness_mean+evenness_se,ymin=evenness_mean-evenness_se),width=0.1)+
  labs(title= "C) Evenness", x="Year", y="Mean relative evenness",colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none", #right
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="evenness_by_year_and_strata_grouped.pdf", path="big_csv/plots")

#richness
rich_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=richness_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.1)+
  labs(title= "D) Richness", x="Year", y="Mean ENS", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="richness_by_year_and_strata_grouped.pdf", path="big_csv/plots")

#simpson
sim_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=simpson_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.1)+
  labs(title= "E) Simpson", x="Year", y="Mean ENS", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="simpson_by_year_and_strata_grouped.pdf", path="big_csv/plots")

#shannon
shan_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=shannon_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=shannon_mean-shannon_se, ymax=shannon_mean+shannon_se), width=.1)+
  labs(title= "F) Shannon", x="Year", y="Mean ENS", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="shannon_by_year_and_strata_grouped.pdf", path="big_csv/plots")

#functional
func_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=func.div_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=func.div_mean+func.div_se,ymin=func.div_mean-func.div_se),width=0.1)+
  labs(title= "G) Functional", x="Year", y="Mean ENS", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="functional_diversity_by_year_and_strata_grouped.pdf", path="big_csv/plots")

#save legend
for_legend_gs_vert = ggplot(matrices_strat_grouped,aes(x=YEAR,y=abundance_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ 
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  labs(colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
    theme(
      legend.position="right", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))
legend_gs_vert <- get_legend(for_legend_gs_vert)

for_legend_gs_horiz = ggplot(matrices_strat_grouped,aes(x=YEAR,y=abundance_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ 
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  labs(colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
    theme(
      legend.position="bottom", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))
legend_gs_horiz <- get_legend(for_legend_gs_horiz)

#combine multiple plots
#all plots on one page
g_gs <- grid.arrange(ab_gs,bio_gs,eve_gs,rich_gs,sim_gs,shan_gs,func_gs,legend_gs_vert,ncol=2)
ggsave(file="all_indices_by_year_and_strata_grouped.pdf", g_gs, width=7, height=10, path="big_csv/plots")

#plots on two pages - letters in plot titles will need to be changed so they make sense on two pages (i.e., A-C and A-D)
g3 <- grid.arrange(ab_gs,bio_gs,eve_gs,legend_gs_vert,ncol=2)
ggsave(file="ab_bio_eve_by_year_and_strata_grouped.pdf", g3, width=7, height=5, path="big_csv/plots")

g4 <- grid.arrange(arrangeGrob(rich_gs,sim_gs,ncol=2),arrangeGrob(shan_gs,func_gs,ncol=2),legend_gs_horiz,nrow=3,heights=c(2,2,.4))
ggsave(file="rich_shan_sim_func_by_year_and_strata_grouped.pdf", g4, width=7, height=6, path="big_csv/plots")


### ***Don't need to combine plots by STRAT and by YEAR just YEAR & STRAT for now***


### ***Didn't run the code below -KS
# by STRAT
#abundance 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=abundance_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=abundance_mean-abundance_se, ymax=abundance_mean+abundance_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#biomass
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=biomass_mean)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean richness 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=richness_mean)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file="fk_MeanRichness_ByStratumForEachYear.pdf", path="big_csv/plots")

#mean simpson 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=simpson_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean shannon 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=shannon_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=shannon_mean-shannon_se, ymax=shannon_mean+shannon_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

# by YEAR
#mean abundance 
ggplot(matrices_strat_grouped, aes(x=YEAR, y=abundance_mean, group=YEAR)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=abundance_mean-abundance_se, ymax=abundance_mean+abundance_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean biomass 
ggplot(matrices_strat_grouped, aes(x=YEAR, y=biomass_mean, group=YEAR)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2, position=position_dodge(.9)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) +
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean richness
ggplot(matrices_strat_grouped, aes(x=YEAR, y=richness_mean, group=YEAR)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT_GROUPED, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean simpson
ggplot(data = matrices_strat_grouped) + 
  geom_boxplot(mapping = aes(x = YEAR, y = simpson_mean, group = YEAR)) +
  facet_wrap(~STRAT_GROUPED, scales="free_y")
#ggsave(file=".pdf", path="big_csv/plots")

#mean shannon 
ggplot(data = matrices_strat_grouped) + 
  geom_boxplot(mapping = aes(x = YEAR, y = shannon_mean, group = YEAR)) +
  facet_wrap(~STRAT_GROUPED, scales="free_y")
#ggsave(file=".pdf", path="big_csv/plots")

```

## Plots of diversity indices by grouped strata across subregions and years  

Group strata by: patch reef, forereef, and high relief
Subregions: UK, MK, LK

```{r Plot by year and subregion and grouped strat} 

if(!file.exists("matrices_strat_grouped_with_subregion_rds")){
  
  all_matrices_data = read_rds("psu_matrices_data_rds") # 5239 x 23
  subregions = as.tibble(read_csv("big_csv/subregion_domains/subregion_domains_by_psu.csv")) # 5241 x 3
  
    #remove PSU-'s with 1 species [2006,602U INPR] [2016,  1010U, INPR]
 subregions = subregions[!(subregions$YEAR == "2006" & subregions$PRIMARY_SAMPLE_UNIT == "602U" | subregions$YEAR == "2016" & subregions$PRIMARY_SAMPLE_UNIT == "1010U"),] #5239 x 3
  
  all_matrices_data_with_subregion = inner_join(all_matrices_data, subregions) #5,239 x 25                  
  
  saveRDS(all_matrices_data_with_subregion, "psu_matrices_data_with_subregion_rds")
  
  matrices_strat_grouped_with_subregion = all_matrices_data_with_subregion %>% 
    mutate(
      STRAT_GROUPED = 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
    group_by(SUBREGION_DOMAIN, STRAT_GROUPED, YEAR) %>% 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness, na.rm = T),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness, na.rm = T),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
  saveRDS(matrices_strat_grouped_with_subregion, "matrices_strat_grouped_with_subregion_rds")
  } else {
    matrices_strat_grouped_with_subregion = read_rds("matrices_strat_grouped_with_subregion_rds") # 184 x 45
    }

#abundance
ab_sy_HR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="HIGH_RELIEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=abundance_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance ()", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="abundance_by_subregion_and_year_High_Relief.pdf", path="big_csv/plots")

ab_sy_LR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="LINEAR_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=abundance_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance ()", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="abundance_by_subregion_and_year_Linear_Reef.pdf", path="big_csv/plots")

ab_sy_PR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="PATCH_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=abundance_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance ()", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="abundance_by_subregion_and_year_Patch_Reef.pdf", path="big_csv/plots")

#biomass
bio_sy_HR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="HIGH_RELIEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=biomass_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=biomass_mean+biomass_se,ymin=biomass_mean-biomass_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Biomass", x="Year", y="Mean biomass ()", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="biomass_by_subregion_and_year_High_Relief.pdf", path="big_csv/plots")

bio_sy_LR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="LINEAR_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=biomass_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=biomass_mean+biomass_se,ymin=biomass_mean-biomass_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Biomass", x="Year", y="Mean biomass ()", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="biomass_by_subregion_and_year_Linear_Reef.pdf", path="big_csv/plots")

bio_sy_PR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="PATCH_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=biomass_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=biomass_mean+biomass_se,ymin=biomass_mean-biomass_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Biomass", x="Year", y="Mean biomass ()", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="biomass_by_subregion_and_year_Patch_Reef.pdf", path="big_csv/plots")

#richness
rich_sy_HR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="HIGH_RELIEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=richness_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=richness_mean+richness_se,ymin=richness_mean-richness_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Richness", x="Year", y="Mean number of effective species", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="richness_by_subregion_and_year_High_Relief.pdf", path="big_csv/plots")

rich_sy_LR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="LINEAR_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=richness_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=richness_mean+richness_se,ymin=richness_mean-richness_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Richness", x="Year", y="Mean number of effective species", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="richness_by_subregion_and_year_Linear_Reef.pdf", path="big_csv/plots")

rich_sy_PR = matrices_strat_grouped_with_subregion %>% filter(STRAT_GROUPED=="PATCH_REEF" & SUBREGION_DOMAIN!="BiscBay") %>% 
  ggplot(.,aes(x=YEAR,y=richness_mean, colour=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+   geom_point(size=3) +
  geom_errorbar(aes(ymax=richness_mean+richness_se,ymin=richness_mean-richness_se),width=0.1)+
  geom_line(aes(group=SUBREGION_DOMAIN),lwd=1)+
  labs(title= "A) Richness", x="Year", y="Mean number of effective species", colour = "Subregion")+
  scale_colour_manual(labels=c("LK", "MK", "UK"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="richness_by_subregion_and_year_Patch_Reef.pdf", path="big_csv/plots")

```

- tried using lapply, seq_along, and for( i in blank) but couldn't get it to work. Then tried melt and came close to what we want, but still need to facet by grouped strata. 

```{r plot test with melt}

all_matrices_data_with_subregion = readRDS("psu_matrices_data_with_subregion_rds")

df = all_matrices_data_with_subregion %>% 
  mutate(
    STRAT_GROUPED = 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
  group_by(SUBREGION_DOMAIN, STRAT_GROUPED, YEAR) %>%
  filter(SUBREGION_DOMAIN !="BiscBay") # 4432 x 25

#Melt dataframe so diversity indices are in a single column
  x = reshape2::melt(df, id.vars = c("YEAR", "SUBREGION_DOMAIN", "STRAT_GROUPED"), measure.vars=c("abundance_sum", "biomass_sum", "evenness","richness","simpson","shannon","func.div")) # 31024 x 5

#Summarize means and SEs by year, subregion, and variable
  x=plyr::ddply(x, c("YEAR", "SUBREGION_DOMAIN", "STRAT_GROUPED", "variable"), summarize, value.mean=mean(value), value.se=plotrix::std.error(value))

#Rename levels for figure plotting
  levels(x$variable)=c("A) Abundance", "B) Biomass", "C) Evenness", "D) Richness", "E) Simpson", "F) Shannon", "G) Functional")

#Rename regions for figure plotting
x$SUBREGION_DOMAIN=factor(x$SUBREGION_DOMAIN)
levels(x$SUBREGION_DOMAIN)=c("Upper Keys", "Middle Keys", "Lower Keys")

#Plot line graph
HR = x %>% filter(STRAT_GROUPED=="HIGH_RELIEF") %>% ggplot(.,aes(x=YEAR, y=value.mean, col=SUBREGION_DOMAIN, group=SUBREGION_DOMAIN))+
  geom_point(size=3)+
  geom_errorbar(aes(ymax=value.mean+value.se,ymin=value.mean-value.se),width=0.1)+
  facet_wrap(~variable,scales="free",ncol=2)+
  #facet_wrap(~variable,scales="free")+
  #facet_wrap(STRAT_GROUPED~variable,scales="free")+
  labs(title= "", x="Year", y="", colour = "Subregion")+
  scale_colour_manual(labels=c("Upper Keys", "Middle Keys", "Lower Keys"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme(
      strip.text=element_text(hjust = 0),
      strip.background = element_blank())
      #plot.margin=unit(c(1,1,1,1),"cm"),
      #legend.position="right",
      #panel.grid.major=element_blank(),
      #panel.grid.minor=element_blank(),
      #strip.background=element_blank())

```

## Plots of diversity indices by grouped strata and years across subregions  

Group strata by: patch reef, forereef, and high relief
Group years by: all years combined
Subregions: UK, MK, LK

```{r Plot by subregion and grouped strat (all years combined)} 

if(!file.exists("matrices_strat_and_year_grouped_with_subregion_rds")){
  
  all_matrices_data = read_rds("psu_matrices_data_rds") # 5239 x 23
  subregions = as.tibble(read_csv("big_csv/subregion_domains/subregion_domains_by_psu.csv")) # 5241 x 3
  
  #remove PSU-'s with 1 species [2006,602U INPR] [2016,  1010U, INPR]
 subregions = subregions[!(subregions$YEAR == "2006" & subregions$PRIMARY_SAMPLE_UNIT == "602U" | subregions$YEAR == "2016" & subregions$PRIMARY_SAMPLE_UNIT == "1010U"),] #5239 x 3
  
  all_matrices_data_with_subregion = inner_join(all_matrices_data, subregions) #5,241 x 25                  
  saveRDS(all_matrices_data_with_subregion, "psu_matrices_data_with_subregion_rds")
  
  matrices_strat_and_year_grouped = all_matrices_data_with_subregion %>% 
    mutate(
      STRAT_GROUPED = 
      ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
             ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                    ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
    group_by(SUBREGION_DOMAIN, STRAT_GROUPED) %>% 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
  saveRDS(matrices_strat_and_year_grouped, "matrices_strat_and_year_grouped_with_subregion_rds")
  } else {
    matrices_strat_and_year_grouped = read_rds("matrices_strat_and_year_grouped_with_subregion_rds")
    }


# by STRAT_GROUPED and subregion
#abundance
ab_sub= ggplot(matrices_strat_and_year_grouped,aes(x=SUBREGION_DOMAIN,y=abundance_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)

geom_line(aes(group=STRAT_GROUPED),lwd=1) +
+
  labs(title= "A) Abundance", x="Year", y="Mean abundance ()", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="abundance_by_subregion_and_strata_grouped.pdf", path="big_csv/plots")


# by STRAT_GROUPED and YEAR
#mean abundance
ggplot(matrices_strat_grouped,aes(x=YEAR,y=abundance_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  labs(title= "A) Mean Abundance", x="Year", y="Abundance of species", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="right",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      plot.caption = element_text(size=10)))
ggsave(file=".pdf", path="big_csv/plots")


#mean biomass
ggplot(matrices_strat_grouped,aes(x=YEAR,y=biomass_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2)+
  labs(title= "B) Mean Biomass", x="Year", y="Biomass of species", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="right",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      plot.caption = element_text(size=10))
ggsave(file="biomass_by_year_strata_subregion.pdf", path="big_csv/plots")
#ggsave(file="", path="big_csv/plots")

#mean richness
ggplot(matrices_strat_grouped,aes(x=YEAR,y=richness_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2)+
  labs(title= "A) Richness", x="Year", y="Effective number of species", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="right",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      plot.caption = element_text(size=10))
ggsave(file="richness_by_year_strata_subregion.pdf", path="big_csv/plots")

#mean simpson
ggplot(matrices_strat_grouped,aes(x=YEAR,y=simpson_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.2)+
  labs(title= "A) Simpson", x="Year", y="Effective number of species", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="right",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      plot.caption = element_text(size=10))
 
#mean shannon
ggplot(matrices_strat_grouped,aes(x=YEAR,y=shannon_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=shannon_mean-shannon_se, ymax=shannon_mean+shannon_se), width=.2)+
  labs(title= "A) Simpson", x="Year", y="Effective number of species", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  theme_bw(base_size=16)+
  theme(
      plot.margin=unit(c(1,1,1,1),"cm"),
      legend.position="right",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      strip.background=element_blank(),
      strip.text.x=element_text(size=18,hjust=0),
      plot.caption = element_text(size=10))

# by STRAT
#abundance 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=abundance_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=abundance_mean-abundance_se, ymax=abundance_mean+abundance_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#biomass
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=biomass_mean)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean richness 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=richness_mean)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file="fk_MeanRichness_ByStratumForEachYear.pdf", path="big_csv/plots")

#mean simpson 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=simpson_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean shannon 
ggplot(matrices_strat_grouped, aes(x=STRAT_GROUPED, y=shannon_mean)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=shannon_mean-shannon_se, ymax=shannon_mean+shannon_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~YEAR, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

# by YEAR
#mean abundance 
ggplot(matrices_strat_grouped, aes(x=YEAR, y=abundance_mean, group=YEAR)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=abundance_mean-abundance_se, ymax=abundance_mean+abundance_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean biomass 
ggplot(matrices_strat_grouped, aes(x=YEAR, y=biomass_mean, group=YEAR)) + 
  geom_bar(position=position_dodge(), stat="identity") + 
  geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.2, position=position_dodge(.9)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) +
  facet_wrap(~STRAT, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean richness
ggplot(matrices_strat_grouped, aes(x=YEAR, y=richness_mean, group=YEAR)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.2, position=position_dodge(.9)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~STRAT_GROUPED, scales='free_y')
#ggsave(file=".pdf", path="big_csv/plots")

#mean simpson
ggplot(data = matrices_strat_grouped) + 
  geom_boxplot(mapping = aes(x = YEAR, y = simpson_mean, group = YEAR)) +
  facet_wrap(~STRAT_GROUPED, scales="free_y")
#ggsave(file=".pdf", path="big_csv/plots")

#mean shannon 
ggplot(data = matrices_strat_grouped) + 
  geom_boxplot(mapping = aes(x = YEAR, y = shannon_mean, group = YEAR)) +
  facet_wrap(~STRAT_GROUPED, scales="free_y")
#ggsave(file=".pdf", path="big_csv/plots")

```

## Plots of diversity indices by level of protection (NTMR) across all years 

```{r plots by PROT}

if(!file.exists("matrices_strat_grouped_rds")){
  
  all_matrices_data = read_rds("psu_matrices_data_rds")
  
  matrices_ntmr = all_matrices_data %>% 
    group_by(YEAR, PROT) %>% #add subregion later 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div),
      evenness_mean = mean(evenness),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness))
  
  saveRDS(matrices_ntmr, "matrices_ntmr_rds")
  
  }else{
  matrices_ntmr = read_rds("matrices_ntmr_rds")
  }

# by YEAR and PROT
#mean abundance
ab_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=abundance_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
    #plot.caption = element_text(size=10))
ggsave(file="abundance_by_year_PROT.pdf", path="big_csv/plots")

#biomass
bio_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=biomass_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=biomass_mean+biomass_se,ymin=biomass_mean-biomass_se),width=0.1)+
  labs(title= "B) Biomass", x="Year", y="Mean biomass", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="biomass_by_year_PROT.pdf", path="big_csv/plots")

# evenness
eve_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=evenness_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=evenness_mean+evenness_se,ymin=evenness_mean-evenness_se),width=0.1)+
  labs(title= "C) Evenness", x="Year", y="Mean relative evenness", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="evenness_by_year_PROT.pdf", path="big_csv/plots")

#richness
rich_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=richness_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=richness_mean+richness_se,ymin=richness_mean-richness_se),width=0.1)+
  labs(title= "D) Richness", x="Year", y="Mean ENS", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="richness_by_year_PROT.pdf", path="big_csv/plots")

#simpson
simp_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=simpson_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=simpson_mean+simpson_se,ymin=simpson_mean-simpson_se),width=0.1)+
  labs(title= "E) Simpson", x="Year", y="Mean ENS", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="simpson_diversity_by_year_PROT.pdf", path="big_csv/plots")

# shannon
shan_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=shannon_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=shannon_mean+shannon_se,ymin=shannon_mean-shannon_se),width=0.1)+
  labs(title= "F) Shannon", x="Year", y="Mean ENS", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="shannon_diversity_by_year_PROT.pdf", path="big_csv/plots")

# functional
func_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=func.div_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=func.div_mean+func.div_se,ymin=func.div_mean-func.div_se),width=0.1)+
  labs(title= "G) Functional", x="Year", y="Mean ENS", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="functional_diversity_by_year_PROT.pdf", path="big_csv/plots")

#save legend
for_legend_prot_vert = ggplot(matrices_ntmr,aes(x=YEAR,y=abundance_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=factor(PROT)),lwd=1) +
  geom_point(size=3) +
  labs(colour = "")+
  scale_colour_manual(labels=c("Protected", "Not Protected"), values= c("red", "blue"))+
    theme(
      legend.position="right", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))

legend_prot_vert <- get_legend(for_legend_prot_vert)

for_legend_prot_horiz = ggplot(matrices_ntmr,aes(x=YEAR,y=abundance_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=factor(PROT)),lwd=1) +
  geom_point(size=3) +
  labs(colour = "")+
  scale_colour_manual(labels=c("Protected", "Not Protected"), values= c("red", "blue"))+
    theme(
      legend.position="bottom", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))
legend_prot_horiz <- get_legend(for_legend_prot_horiz)

#combine multiple plots
#all plots on one page
g_prot <- grid.arrange(ab_prot,bio_prot,eve_prot,rich_prot,simp_prot,shan_prot,func_prot,legend_prot_vert,ncol=2)

ggsave(file="all_indices_by_year_and_prot.pdf", g_prot, width=7, height=10, path="big_csv/plots")

#plots on two pages - letters in plot titles will need to be changed so they make sense on two pages (i.e., A-C and A-D)
g3 <- grid.arrange(ab_gs,bio_gs,eve_gs,legend_gs_vert,ncol=2)
ggsave(file="ab_bio_eve_by_year_and_strata_grouped.pdf", g3, width=7, height=5, path="big_csv/plots")

g4 <- grid.arrange(arrangeGrob(rich_gs,sim_gs,ncol=2),arrangeGrob(shan_gs,func_gs,ncol=2),legend_gs_horiz,nrow=3,heights=c(2,2,.4))
ggsave(file="rich_shan_sim_func_by_year_and_strata_grouped.pdf", g4, width=7, height=6, path="big_csv/plots")


```

# Map of diversity indices 

```{r mapping libraries}

library(automap) #Calls: autoKrige
library(ggplot2) #Calls: ggplot
library(gridExtra) #Calls: grid.arrange
library(parallel) #Calls: clusterEvalQ,clusterExport,detectCores,makeCluster,parLapply
library(raster)
library(rgdal) #readOGR 
library(rgeos)
library(sp) #Calls: coordinates, spsample
library(tidyverse)

#Create socket cluster of multiple cores 
cl=makeCluster(detectCores()) #shouls i make type = "base" or "FORK"??
#Load automap on all cores (to access function `autoKrige`)
clusterEvalQ(cl,c(library(automap),library(mgcv),library(plotrix)))

```

```{r Map matrices}

#Generate figure legend based on FKNMS map 

#Read in shapefile and fortify
if (!file.exists('fk.shp.fortify_rds')){
fk.shp = readOGR( dsn = "FKNMS_sample_grid", layer = "FlaKeys_Grid") 
fk.shp.fortify = fortify(fk.shp) 
saveRDS(fk.shp.fortify, 'fk.shp.fortify_rds')
} else{ 
  fk.shp.fortify = readRDS('fk.shp.fortify_rds')
}

```

Examine spatial and temporal trends in the different dimensions of reef fish diversity. 

- Interpolate diversity for each strata/region/year groupings using kriging 
```{r Kriging}

#read in data 
all_matrices_data = read_rds("psu_matrices_data_rds")

#remove 1999 and 2000 where there is no FDLR 
all_matrices_data = all_matrices_data %>%
  filter(YEAR != "1999") %>%
  filter(YEAR != "2000") %>% #4852*24 variables 
  select(YEAR, PRIMARY_SAMPLE_UNIT, abundance_sum, biomass_sum, richness,   simpson,shannon, func.div, evenness, LAT_DEGREES, LON_DEGREES) %>%
  mutate(YEARGRP = 
         if_else(grepl("2001|2002|2003|2004|2005|2006|2007", YEAR), "2001-2007",
                 if_else(grepl("2008|2009|2010|2011|2012|2014|2016", YEAR), "2008-2016", "whatevs")))
  
#Create new list of data frames to convert to SpatialPointsDataFrame
  alphasp.list= all_matrices_data
  names(alphasp.list)=names(all_matrices_data)

#remove YEAR and PSU columns 
alphasp.list = alphasp.list[,(3:11)] #4552 obv of 9 variables 
as.data.frame(alphasp.list)

#Convert class("dataframe") into class("SpatialPointsDataFrame")
for(i in (alphasp.list)) {
coordinates(alphasp.list)=~LON_DEGREES+LAT_DEGREES }

class(alphasp.list)
#[1] "SpatialPointsDataFrame"
#attr(,"package")
#[1] "sp"

#Project lat long coordinates onto an ellipse
sp::proj4string(alphasp.list)="+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs" 

#Transform the projection into cartesian coordinates
spTransform(alphasp.list,CRS("+proj=utm +zone=18 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0"))  
#class       : SpatialPointsDataFrame 
#features    : 4852 
#extent      : -211587.2, -10735.89, 2719660, 2858288  (xmin, xmax, ymin, ymax)
#coord. ref. : +proj=utm +zone=18 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0 
#variables   : 7
#names       : abundance_sum,         biomass_sum, richness,          simpson,         shannon,         func.div,            evenness 
#min values  :             1, 0.00847432325884381,        1,                1,               1,                1, 0.00602329496841305 
#max values  :    100229.008,    4846.09878101597,       73, 21.4394504111935, 31.268608778863, 4.25903920146755,                   1 

#Create a spatial grid onto which interpolated values can be plotted

if(!file.exists("krigeall.list_rds")){
  
  #read in shapefile 
  fk.shp = readOGR( dsn = "FKNMS_sample_grid", layer = "FlaKeys_Grid") 
  #OGR data source with driver: ESRI Shapefile 
  #Source: "FKNMS_sample_grid", layer: "FlaKeys_Grid" with 67568 features
  #It has 21 fields
  
  #Generate interpolation grid
  fknms.shp=spTransform(fk.shp,CRS("+proj=utm +zone=18 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0 ")) 
  
  grd=spsample(fknms.shp,type="regular",n=2500,nsig=2) #n is sample size but of what???
  par(mfrow=c(1,1))
  plot(grd)
  
  #Send interpolation grid to each core
  parallel::clusterExport(cl, varlist=c("grd")) #are these being sent correctly to "cl"??
  #do I want type= "base", "FORK" OR "PSOCK"???
  
  #Perform kriging interpolation for each matrix
  
  #responses are log transformed to better meet assumptions of normality of errors and constant variance. .... except my abun and bio still dont meet assumtions even after transformation
  
  krigeall.list= parLapply(cl,alphasp.list,function(i) {
    lapply(names(i@data)[1:7],function(j) {
      as.data.frame(autoKrige(formula(paste("log10(",j,")~1")),i,grd)$krige_output) } ) } )
  #Error: Column indexes must be at most 7 if positive, not 8, 9, 10 etc...
  
    lapply(names(alphasp.list@data)[1:7],function(j) {
      as.data.frame(autoKrige(formula(paste("log10(",j,")~1")),alphasp.list,grd)$krige_output) } ) 
        
    # Error in autoKrige(formula(paste("log10(", j, ")~1")), alphasp.list, grd) : 
  # Either input_data or new_data is in LongLat, please reproject.
  #  input_data:  +proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0 
  #  new_data:    +proj=utm +zone=18 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0 
    
#autoKrige(formulas, input_data, new_data)  
  #prediction_spdf = kr$krige_output 
#Tried: 
#as.data.frame(autoKrige(formula(paste("log10(",alphasp.list@data$abundance_sum,")~1")),alphasp.list,grd)$krige_output)
    #got:Error in autoKrige(formula(paste("log10(", alphasp.list@data$abundance_sum,  : 
  #Either input_data or new_data is in LongLat, please reproject.
   #input_data:  +proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0 
   #new_data:    +proj=utm +zone=18 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0 
  
  
  saveRDS(krigeall.list, "krigeall.list_rds") 
  
  } {else 
    krigeall.list = readRDS("krigeall.list_rds") 
  }

#Apply names for titling during plotting
for(i in (krigeall.list)) {
  names(krigeall.list)= c("A) Mean Abundance","B) Mean Biomass","C) Richness", "D) Evenness", "E) Simpson","F) Shannon","G) Functional") 
}

#Plot all components across all years 
lapply((krigeall.list),function(i) {
  do.call(grid.arrange,lapply((krigeall.list[[i]]),function(j) {
    ggplot()+
      geom_raster(data=krigeall.list[[j]],aes(x=x1,y=x2,fill=var1.pred))+
      scale_fill_gradientn(colours=rev(rainbow(3)))+
      coord_equal()+
      labs(x="",y="",title=paste(names(krigeall.list)))+
                         theme_bw()+
                         theme(plot.margin=unit(c(0,0,0,0),"cm"),
                               axis.text.x=element_blank(),axis.text.y=element_blank(),
                               axis.ticks=element_blank(),legend.title=element_blank()) 
           } ) ) 
    } )

#Repeat for grouped years 
  krigeyear.list=parLapply(cl,alphasp.list,function(i) {
    lapply(names(i@data)[66:71],function(j) {
      lapply(unique((i@data)$YEARGRP),function(k) {
        if(j=="evenness") {
          as.data.frame(autoKrige(formula(paste("asin(sqrt(",j,"))~1")),subset(i,i@data$YEARGRP==k),grd)$krige_output)
        } else {
          as.data.frame(autoKrige(formula(paste("log(",j,")~1")),subset(i,i@data$YEARGRP==k),grd)$krige_output)  }
      } ) } ) } )

#Apply names for titling during plotting for grouped years 
for(i in (krigeyear.list)) {
  names(krigeyear.list[[i]])=c("A) Mean Abundance","B) Mean Biomass","C) Richness", "D) Evenness", "E) Simpson","F) Shannon","G) Functional") }
for(i in (krigeyear.list)) {
  for(j in (krigeyear.list[[i]])) {
    names(krigeyear.list[[i]][[j]])=c("2001-2007","2007-2017") } }

#Collapse lists into data frame
krigeyear.list=lapply(krigeyear.list,function(i) lapply(i,function(j) do.call(rbind,j)))

#Order levels of years for facetting
for(i in (krigeyear.list)) {
  for(j in (krigeyear.list[[i]])) { 
    krigeyear.list[[i]][[j]]$YEARGRP=factor(krigeyear.list[[i]][[j]]$YEARGRP,levels=c("2001-2007","2007-2017")) } }

#Plot and facet by grouped year (12" x 18")
lapply(seq_along(krigeyear.list),function(i) {
  do.call(grid.arrange,c(lapply(seq_along(krigeyear.list[[i]]),function(j) {
    if(j!=2) {
      ggplot()+
        geom_raster(data=krigeyear.list[[i]][[j]],aes(x=x1,y=x2,fill=exp(var1.pred)))+
        scale_fill_gradientn(colours=rev(rainbow(3)))+
        facet_wrap(~YEARGRP,nrow=1)+
        coord_equal()+labs(x="",y="",title=names(krigeyear.list[[i]])[j])+
        theme_bw()+theme(plot.margin=unit(c(0,0,0,0),"cm"),
                   plot.title=element_text(size=18,hjust=0,vjust=1),
                   strip.text=element_text(size=12),
                   panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
                   axis.text.x=element_blank(),axis.text.y=element_blank(),
                   axis.ticks=element_blank(),legend.title=element_blank()) 
    } else {
      ggplot()+
        geom_raster(data=krigeyear.list[[i]][[j]],aes(x=x1,y=x2,fill=sin(var1.pred)^2))+
        scale_fill_gradientn(colours=rev(rainbow(3)))+
        facet_wrap(~YEARGRP,nrow=1)+
        coord_equal()+labs(x="",y="",title=names(krigeyear.list[[i]])[j])+
        theme_bw()+theme(plot.margin=unit(c(0,0,0,0),"cm"),
                     plot.title=element_text(size=18,hjust=0,vjust=1),
                     strip.text=element_text(size=12),
                     panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
                     axis.text.x=element_blank(),axis.text.y=element_blank(),
                     axis.ticks=element_blank(),legend.title=element_blank()) }
  } ), list(ncol=2)) )
} )

```

## Build GAM model with temporal, spatial, environmental and management variables 

$y_i = \alpha + f_1(X_1i) + f_2(X_2i) + g_1(X_3i) + g_2(X_4i) + \epsilon_i$
$y_i = \alpha + f_1 (YEAR)+ f_2(PROT) + g_1(LONG, LAT)* YEAR + g_2(STRAT) + \epsilon_i$

$y_i$ is the calculated diversity for station i (response variable)
$\alpha$ is the intercept that scales the model prediction to the appropriate level of the response
$f_1 (X_1i)$ is a smoother
$g_1 (X_1i)$ is nonparametric smoother for covariates strata
$\epsilon_i$ the residual error

Temporal variables:
- YEAR: Year (categorical factor)

Spatial variables:
- latitude and longitude (continuous covariate)

Environmental variables: 
- strata (categorical factor)
- bottom depth (continuous covariate)

Management variable:
- PROT: No take marine reserve  (categorical factor)

Conitinuous covariates: modeled using non-parametric smoothing 
- thin plate regression splines with shrinkage terms (Ciannelli et al., 2008)

Categorical factors: models parametrically to determine their mean effect sizes (Zurr et al., 2009)

Fit GAM to each index separately. 

- To assess the explanatory power of each variable calculate the partial deviances by sequentially removing suites of predictors from the full gam model corresponding to indicators of space, time, environment, or management. 

- Repeat this for all possible permutations 

- Average the deviances for all models in which the predictor appeared and calculate the standard error 

- the partial deviances are the proportion of total explained deviance of the model uniquely explained by space, time, environment or management, accounting for the other predictors in the model. 

```{r GAM and Partial deviances}

library(mgcv) #gam
#Build full model and null model based on (transformed) response variable
#s() smooth term in gam model 
#bs() a two letter character string indicating the smoothing basis to use (ts plate regression splines)

# 1. Read in data and remove years (optional)
all_matrices_data = read_rds("psu_matrices_data_rds")

as.data.frame(all_matrices_data)
#names(all_matrices_data)

#Send all_matrices_data to each core
clusterExport(cl,varlist=c("all_matrices_data")) #varlist - character vector of names of objects to export

partial.deviance.list=parLapply(cl,all_matrices_data,function(i) {
  do.call(rbind,lapply(list("abundance_sum","biomass_sum","richness","evenness", "simpson","shannon", "functional"),function(j) {
    
    #Subset only columns that are necessary to run the models and omit any NAs so all models are run on the same data
    data=na.omit(all_matrices_data[[i]][,c("YEAR","LON_DEGREES","LAT_DEGREES","DEPTH","STRAT","PROT","abundance_sum","biomass_sum","richness","simpson","shannon", "evenness", "func.div")])
    
    #Build full model and null model based on (transformed) response variable
    if(j=="richness") {
      fullmod = gam(formula(paste(j,"~YEAR+STRAT+PROT+s(LONG_DEGREES,LAT_DEGREES,  by=YEAR, bs='ts')+s(DEPTH, by='ts')")), family=poisson, data=data)
      nullmod = gam(formula(paste(j,"~1")), family=poisson, data=data)
      
      } else if(j=="evenness") {
    fullmod=gam(formula(paste("asin(sqrt(",j,"))~Year+STRAT+PROT+s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')+s(DEPTH,bs='ts')")), data=data)
    
   } else {
      fullmod = gam(formula(paste("log(",j,")~YEAR+STRAT+PROT+s(LONG_DEGREES,LAT_DEGREES, by=YEAR, bs='ts')+s(DEPTH, by='ts')")), data=data)
      nullmod = gam(formula(paste("log(",j,")~1")), data=data)
   }
    
    
  #Set up empty vectors for deviances
  time.dev=c();space.dev=c(); env.dev=c(); mngt.dev=c()

  #time deviances 
    
    #Sequence 1: time->space->mangement->environment
    time.dev[1]=
      (deviance(update(fullmod,.~.-YEAR,
                       sp=fullmod$sp))-
         deviance(fullmod))/deviance(nullmod)
    
    space.dev[1]=
      (deviance(update(fullmod,.~.-YEAR-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/deviance(nullmod)
    
    mngt.dev[1]=
      (deviance(update(fullmod,.~.-YEAR-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/deviance(nullmod)
    
    env.dev[1]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,
                         sp=fullmod$sp[6:9])))/deviance(nullmod)
    
    #Sequence 2: time->space->environment->mangement
    time.dev[2]=
      (deviance(update(fullmod,.~.-YEAR,
                       sp=fullmod$sp))-
         deviance(fullmod))/deviance(nullmod)
    
    space.dev[2]=
      (deviance(update(fullmod,.~.-YEAR-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-YEAR,
                         sp=fullmod$sp)))/deviance(nullmod)
    
    env.dev[2]=
      (deviance(update(fullmod,.~.-YEAR-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-YEAR,
                         sp=fullmod$sp)))/deviance(nullmod)
    
    mngt.dev[2]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)

    #sequence 3: time->management->environment->space  
    time.dev[3]=
      (deviance(update(fullmod,.~.-YEAR,
                       sp=fullmod$sp))-
         deviance(fullmod))/deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-YEAR,
                         sp=fullmod$sp)))/deviance(nullmod)

    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-YEAR,
                         sp=fullmod$sp)))/deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    #sequence 4: time->management->space->environment  
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR,
                       sp=fullmod$sp))-
         deviance(fullmod))/deviance(nullmod)
    
    mngt.dev[4]=
      (deviance(update(fullmod,.~.-YEAR-PROT,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-YEAR,
                         sp=fullmod$sp)))/deviance(nullmod)

    space.dev[4]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-YEAR,
                         sp=fullmod$sp)))/deviance(nullmod)
    
    env.dev[4]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)

    #Sequence 5: time->environment->space->management
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR,
                       sp=fullmod$sp))-
         deviance(fullmod))/deviance(nullmod)
    
    env.dev[5]=
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-YEAR,
                         sp=fullmod$sp)))/deviance(nullmod)
    
    space.dev[5]=
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-YEAR,
                         sp=fullmod$sp)))/deviance(nullmod)
  
    mngt.dev[5]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT-s(DEPTH,bs='ts')-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    #Sequence 6: time->environment->management->space
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR,
                       sp=fullmod$sp))-
         deviance(fullmod))/deviance(nullmod)
    
    env.dev[6]=
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/deviance(nullmod)
    
    mngt.dev[6]=
      (deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/deviance(nullmod)
  
    space.dev[6]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-STRAT-s(DEPTH,bs='ts')-PROT,
                         sp=fullmod$sp[1:5])))/deviance(nullmod)

#Space deviances
    
#Sequence 7: space->time->environment->management 
    space.dev[7]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(fullmod))/deviance(nullmod)
    
    time.dev[7]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)
    
    mngt.dev[7]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)
    
    env.dev[7]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,
                         sp=fullmod$sp[6:9])))/deviance(nullmod)

#Sequence 8: space->time->management->environment
    space.dev[8]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(fullmod))/deviance(nullmod)
    
    time.dev[8]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)
    
    env.dev[8]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)
    
    mngt.dev[8]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)    
    

#Sequence 10: space->time->environment->mangement 
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(fullmod))/deviance(nullmod)
    
     env.dev[9]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[9:9])))/deviance(nullmod)
    
    mngt.dev[9]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT,
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)
    
     time.dev[9]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-PROT)))/deviance(nullmod)
     
#Sequence 10: space->environment->time->mangement 
    space.dev[10]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(fullmod))/deviance(nullmod)
    
     env.dev[10]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)
    
     time.dev[10]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR,
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)
    
     mngt.dev[10]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT-s(DEPTH,bs='ts')-YEAR)))/deviance(nullmod)
     
#Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(fullmod))/deviance(nullmod)
    
     mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)
    
     time.dev[11]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)
    
     env.dev[11]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR)))/deviance(nullmod)
     
#Sequence 12: space->mangement->environment->time
    space.dev[12]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(fullmod))/deviance(nullmod)
    
     mngt.dev[12]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[12:12])))/deviance(nullmod)
    
    env.dev[12]=
      (deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[6:9]))-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[6:9])))/deviance(nullmod)
    
     time.dev[12]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT-s(DEPTH,bs='ts'))))/deviance(nullmod)

#Environment deviances

    #Sequence 13: environment->time->space->management 
    env.dev[13]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    time.dev[13]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    space.dev[13]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:13])))/deviance(nullmod)
    
    mngt.dev[13]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    #Sequence 14: environment->time->management->space
    env.dev[14]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    time.dev[14]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    mngt.dev[14]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    space.dev[14]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-YEAR-PROT,
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    #Sequence 15: environment->space->management->time
    env.dev[15]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    space.dev[15]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    mngt.dev[15]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    time.dev[15]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    env.dev[16]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    space.dev[16]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    time.dev[16]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    mngt.dev[17]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    space.dev[17]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    time.dev[17]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/deviance(nullmod)
    
    #Sequence 18: environment->management->time->space
    env.dev[18]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    mngt.dev[18]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    time.dev[18]=
      (deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    space.dev[18]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts')-PROT-YEAR)))/deviance(nullmod)

#management deviances

    #Sequence 19: management->environment->time->space
    mngt.dev[19]=
      (deviance(update(fullmod,.~.-PROT,
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    env.dev[19]=
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    time.dev[19]=
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    space.dev[19]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-YEAR)))/deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    mngt.dev[20]=
      (deviance(update(fullmod,.~.-PROT,
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    env.dev[20]=
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    space.dev[20]=
      (deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    time.dev[20]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT-s(DEPTH,bs='ts')-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]=
      (deviance(update(fullmod,.~.-PROT,
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    space.dev[21]=
      (deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    time.dev[21]=
      (deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    env.dev[21]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/deviance(nullmod)
    
    #Sequence 22: management->space->environment->timE
    mngt.dev[22]=
      (deviance(update(fullmod,.~.-PROT,
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    space.dev[22]=
      (deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    env.dev[22]=
      (deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    time.dev[22]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    mngt.dev[23]=
      (deviance(update(fullmod,.~.-PROT,
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    space.dev[23]=
      (deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    env.dev[23]=
      (deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    time.dev[23]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/deviance(nullmod)
    
    #Sequence 24: management->time->environment->space
    mngt.dev[24]=
      (deviance(update(fullmod,.~.-PROT,
                       sp=fullmod$sp[1:5]))-
         deviance(fullmod))/deviance(nullmod)
    
    space.dev[24]=
      (deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    env.dev[24]=
      (deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,
                       sp=fullmod$sp[1:5]))-
         deviance(update(fullmod,.~.-STRAT-s(DEPTH,bs='ts'),
                         sp=fullmod$sp[1:5])))/deviance(nullmod)
    
    time.dev[24]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LONG_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/deviance(nullmod)

  #Bind results into data.frame
  prop.deviance=data.frame(
    Diversity=paste(j),
    Predictor=c("All","Space","Time","Environment","Management"),
    Partial.Deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    Partial.Deviance.SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
} ) ) } )

#Error in checkForRemoteErrors(val) : 4 nodes produced errors; first error: no such index at level 1

#Close the cluster
stopCluster(cl)

#Name objects in list
names(partial.deviance.list)=c("abund","biomass","pres.abs")
#Rename diversity levels for better plotting
for(i in seq_along(partial.deviance.list)) {
  partial.deviance.list[[i]]=transform(partial.deviance.list[[i]],Diversity=recode(Diversity,
    "'richness'='Richness';'evenness'='Evenness';'species.div'='Gini-Simpson';
     'func.div'='Functional';'phylo.div'='Phylogenetic';'taxo.div'='Taxonomic'")) }
#Reorder diversity levels for better plotting
for(i in seq_along(partial.deviance.list)) {
  partial.deviance.list[[i]][,"Diversity"]=factor(partial.deviance.list[[i]][,"Diversity"],
    levels=c("Richness","Evenness","Gini-Simpson","Functional","Phylogenetic","Taxonomic")) }

#Create barplot (8" x 6")
lapply(seq_along(partial.deviance.list),function(i) {
  data=subset(partial.deviance.list[[i]],Predictor!="All")
  ggplot(data,aes(x=Diversity,y=Partial.Deviance*100,fill=Predictor))+
    geom_bar(position="dodge",color="black")+
    geom_errorbar(aes(max=(Partial.Deviance+Partial.Deviance.SE)*100,
                      min=(Partial.Deviance-Partial.Deviance.SE)*100),
                  width=0.3,size=0.6,position=position_dodge(width=0.9))+
    labs(x="",y="Total % Deviance Explained\n")+
    scale_fill_manual(values=c("grey50","grey80","white"))+
    theme_bw(base_size=18)+theme(
      panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
      legend.position="bottom",legend.title=element_blank()) } )
```

